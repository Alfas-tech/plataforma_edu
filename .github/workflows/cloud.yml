name: CI/CD Pipeline - Google Cloud Run
#test
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: plataforma-edu
  REGION: southamerica-east1
  REPOSITORY: cd
  IMAGE_NAME: southamerica-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/app
  PNPM_VERSION: "9.6.0"
  NODE_VERSION: "20.19.4"

jobs:
  # ============================================
  # CONTINUOUS INTEGRATION
  # ============================================

  build:
    name: ðŸ”¨ Build Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Next.js application
        run: pnpm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
          NEXT_PUBLIC_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET }}
          NEXT_TELEMETRY_DISABLED: 1

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: .next
          retention-days: 1

  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm run test:ci

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: coverage
          retention-days: 7

  acceptance-test:
    name: âœ… Acceptance Tests
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm run lint

      - name: Check code formatting
        run: pnpm run format:check

  # ============================================
  # CONTINUOUS DEPLOYMENT
  # ============================================

  build-image:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    needs: acceptance-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker southamerica-east1-docker.pkg.dev

      - name: Build Docker image
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }} \
            --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }} \
            --build-arg NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }} \
            --build-arg NEXT_PUBLIC_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET }} \
            -t ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.IMAGE_NAME }}:staging \
            -t ${{ env.IMAGE_NAME }}:latest \
            .

      - name: Push Docker images to Artifact Registry
        run: |
          docker push ${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.IMAGE_NAME }}:staging
          docker push ${{ env.IMAGE_NAME }}:latest

  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-image
    environment:
      name: staging
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run (Staging)
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }}-staging \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --set-env-vars "NODE_ENV=staging" \
            --set-env-vars "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" \
            --set-env-vars "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" \
            --set-env-vars "NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL_STAGING }}" \
            --set-env-vars "NEXT_PUBLIC_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET }}" \
            --set-env-vars "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            --set-env-vars "SUPABASE_STORAGE_ACCESS_KEY_ID=${{ secrets.SUPABASE_STORAGE_ACCESS_KEY_ID }}" \
            --set-env-vars "SUPABASE_STORAGE_SECRET_KEY=${{ secrets.SUPABASE_STORAGE_SECRET_KEY }}" \
            --set-env-vars "SUPABASE_STORAGE_ENDPOINT=${{ secrets.SUPABASE_STORAGE_ENDPOINT }}" \
            --set-env-vars "SUPABASE_STORAGE_REGION=${{ secrets.SUPABASE_STORAGE_REGION }}" \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --max-instances 5 \
            --min-instances 0 \
            --tag staging

      - name: Get Staging URL
        id: get-url
        run: |
          STAGING_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }}-staging \
              --platform managed \
              --region ${{ env.REGION }} \
              --format 'value(status.url)')
          echo "url=$STAGING_URL" >> $GITHUB_OUTPUT
          echo "ðŸ”— Staging URL: $STAGING_URL"

      - name: Wait for service to be ready
        run: sleep 30

  deploy-production:
    name: ðŸŽ¯ Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run (Production)
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --set-env-vars "NODE_ENV=production" \
            --set-env-vars "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" \
            --set-env-vars "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" \
            --set-env-vars "NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }}" \
            --set-env-vars "NEXT_PUBLIC_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET }}" \
            --set-env-vars "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            --set-env-vars "SUPABASE_STORAGE_ACCESS_KEY_ID=${{ secrets.SUPABASE_STORAGE_ACCESS_KEY_ID }}" \
            --set-env-vars "SUPABASE_STORAGE_SECRET_KEY=${{ secrets.SUPABASE_STORAGE_SECRET_KEY }}" \
            --set-env-vars "SUPABASE_STORAGE_ENDPOINT=${{ secrets.SUPABASE_STORAGE_ENDPOINT }}" \
            --set-env-vars "SUPABASE_STORAGE_REGION=${{ secrets.SUPABASE_STORAGE_REGION }}" \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --max-instances 10 \
            --min-instances 0 \
            --tag production

      - name: Get Production URL
        id: get-url
        run: |
          PROD_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "url=$PROD_URL" >> $GITHUB_OUTPUT
          echo "ðŸ”— Production URL: $PROD_URL"

      - name: Wait for service to be ready
        run: sleep 30

  smoke-tests:
    name: ðŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Production URL
        id: get-url
        run: |
          PROD_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "url=$PROD_URL" >> $GITHUB_OUTPUT

      - name: Test Health Endpoint
        run: |
          echo "Testing health endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.get-url.outputs.url }}/api/health)
          if [ "$response" != "200" ]; then
            echo "âŒ Health check failed with status $response"
            exit 1
          fi
          echo "âœ… Health check passed"

      - name: Test Homepage
        run: |
          echo "Testing homepage..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.get-url.outputs.url }})
          if [ "$response" != "200" ]; then
            echo "âŒ Homepage test failed with status $response"
            exit 1
          fi
          echo "âœ… Homepage test passed"

      - name: Test Response Time
        run: |
          echo "Testing response time..."
          time=$(curl -o /dev/null -s -w '%{time_total}\n' ${{ steps.get-url.outputs.url }})
          echo "Response time: ${time}s"
          if (( $(echo "$time > 5.0" | bc -l) )); then
            echo "âš ï¸  Warning: Response time is slow (>${time}s)"
          else
            echo "âœ… Response time is acceptable"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "================================================"
          echo "ðŸŽ‰ DEPLOYMENT COMPLETED SUCCESSFULLY"
          echo "================================================"
          echo "ðŸ“¦ Image: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "ðŸ”— Production URL: ${{ steps.get-url.outputs.url }}"
          echo "================================================"
